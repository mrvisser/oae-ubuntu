require(["jquery","underscore","oae.core","/admin/js/admin.util.4b1e0aa3.js","jquery.jeditable","jquery.spectrum","jquery.history"],function(e,t,n,r){var i=null,s=null,o=null,u=null,a={},f=function(){e(this).next().toggle(400)},l=function(){e(".jeditable-field").editable(function(t){return t=e.trim(t),t?(e.ajax({url:"/api/tenant",type:"POST",data:{alias:e(this).attr("data-alias"),displayName:t},success:function(){n.api.util.notification("Tenant name updated.","The tenant name has been successfully updated.")}}),t):(n.api.util.notification("Invalid tenant name.","Please enter a tenant name.","error"),this.revert)},{tooltip:"Click to edit name",select:!0})},c=function(){var t=History.getState().data.view||"tenants";e("#admin-views > div").hide(),e("#admin-lhnav-container li").removeClass("active"),e('#admin-lhnav-container li[data-id="'+t+'"]').addClass("active");switch(t){case"modules":e("#admin-views > #admin-modules-container").show();break;case"skinning":e("#admin-views > #admin-skinning-container").show();break;default:e("#admin-views > #admin-tenants-container").show()}},h=function(){var t=e(this),r=t.serializeObject(),s={},a=t.attr("data-module");e.each(u[a],function(t,n){e.each(n,function(e,n){var i=a+"/"+t+"/"+e;o[a][t].elements[e].type==="boolean"&&(r[i]=r[i]?!0:!1),r[i]!==n&&(s[i]=r[i],u[a][t][e]=r[i])})});var f="/api/config";return i.isTenantOnGlobalAdminServer&&(f+="/"+i.alias),e.isEmptyObject(s)||e.ajax({url:f,type:"POST",data:s,success:function(){n.api.util.notification("Configuration saved.","The configuration was successfully saved.")},error:function(){n.api.util.notification("Configuration not saved.","The configuration could not be saved successfully.","error")}}),!1},p=function(){return e.ajax({url:"/api/tenant/create",type:"POST",data:{alias:e.trim(e("#createtenant-alias").val()),displayName:e.trim(e("#createtenant-displayName").val()),host:e.trim(e("#createtenant-host").val())},success:function(){n.api.util.notification("Tenant created.",'The new tenant "'+e("#createtenant-displayName").val()+'" has been successfully created.'),M()},error:function(e,t){n.api.util.notification("Tenant could not be created.",e.responseText,"error")}}),!1},d=function(t,n){e.ajax({url:"/api/tenant/delete",type:"POST",data:{aliases:t},success:function(e){M(),n(null)},error:function(e,t){n({code:e.status,msg:e.statusText})}})},v=function(t,n){e.ajax({url:"/api/tenant/start",type:"POST",data:{aliases:t},success:function(e){M(),n(null)},error:function(e,t){n({code:e.status,msg:e.statusText})}})},m=function(t,n){e.ajax({url:"/api/tenant/stop",type:"POST",data:{aliases:t},success:function(e){M(),n(null)},error:function(e,t){n({code:e.status,msg:e.statusText})}})},g=function(){r.showConfirmationModal({id:"start-all-tenants-modal",title:"Start all tenants",message:"Are you sure you want to start ALL tenants?",cancel:"Cancel",confirm:"Yes, start all tenants",confirmclass:"btn-success",confirmed:function(){v(t.keys(s),function(t){e("#start-all-tenants-modal").modal("hide"),t?n.api.util.notification("Tenants not started.","Not all tenants could be started.","error"):n.api.util.notification("Tenants started.","All tenants where successfully started.")})}})},y=function(){r.showConfirmationModal({id:"stop-all-tenants-modal",title:"Stop all tenants",message:"Are you sure you want to stop ALL tenants?",cancel:"Cancel",confirm:"Yes, stop all tenants",confirmclass:"btn-warning",confirmed:function(){m(t.keys(s),function(t){e("#stop-all-tenants-modal").modal("hide"),t?n.api.util.notification("Tenants not stopped.","Not all tenants could be stopped.","error"):n.api.util.notification("Tenants stopped.","All tenants where successfully stopped.")})}})},b=function(){var t=e(this).attr("data-displayName"),i=e(this).attr("data-alias");r.showConfirmationModal({id:"deletetenant-modal",title:'Delete tenant "'+t+'"',message:'Are you sure you want to delete tenant "'+t+'"?',cancel:"Cancel",confirm:'Yes, delete "'+t+'"',confirmclass:"btn-danger",confirmed:function(){d([i],function(r){e("#deletetenant-modal").modal("hide"),r?n.api.util.notification("Tenant not deleted.","The tenant could not be deleted.","error"):n.api.util.notification("Tenant deleted.","Tenant "+t+" was successfully deleted.")})}})},w=function(){var t=e(this).attr("data-displayName"),i=e(this).attr("data-alias");r.showConfirmationModal({id:"stoptenant-modal",title:'Stop tenant "'+t+'"',message:'Are you sure you want to stop tenant "'+t+'"?',cancel:"Cancel",confirm:'Yes, stop "'+t+'"',confirmclass:"btn-warning",confirmed:function(){m([i],function(r){e("#stoptenant-modal").modal("hide"),r?n.api.util.notification("Tenant not stopped.","The tenant could not be stopped.","error"):n.api.util.notification("Tenant stopped.","Tenant "+t+" was successfully stopped.")})}})},E=function(){var t=e(this).attr("data-displayName"),i=e(this).attr("data-alias");r.showConfirmationModal({id:"starttenant-modal",title:'start tenant "'+t+'"',message:'Are you sure you want to start tenant "'+t+'"?',cancel:"Cancel",confirm:"Yes, start "+t,confirmclass:"btn-success",confirmed:function(){v([i],function(r){e("#starttenant-modal").modal("hide"),r?n.api.util.notification("Tenant not started.","The tenant could not be started.","error"):n.api.util.notification("Tenant started.","Tenant "+t+" was successfully started.")})}})},S=function(){e("#admin-login-container").show(),n.api.util.validation().validate(e("#admin-login-form"),{submitHandler:x})},x=function(){return n.api.authentication.login(e("#admin-login-form-username").val(),e("#admin-login-form-password").val(),function(e){e?n.api.util.notification("Login failed.","Invalid username or password.","error"):window.location.reload(!0)}),!1},T=function(){n.api.authentication.logout(function(){window.location.reload(!0)})},N=function(){var t=e(this).attr("data-alias");C(t,function(t,r){if(t)n.api.util.notification("Token error.","Could not retrieve a token to log onto the tenant.","error");else{var i=e("#admin-tenant-login-form");i.attr("action","//"+r.host+"/api/auth/signed"),e("#admin-tenant-login-form-expires",i).val(r.expires),e("#admin-tenant-login-form-signature",i).val(r.signature),e("#admin-tenant-login-form-userid",i).val(r.userId),i.submit()}})},C=function(t,n){e.ajax({url:"/api/auth/signed",data:{tenant:t},success:function(e){n(null,e)},error:function(e,t){n({code:e.status,msg:e.statusText})}})},k=function(){i.host&&e.ajax({url:"/api/ui/skin/variables",data:{tenant:i.alias},success:function(t){var r={};u["oae-ui"].skin.variables&&(r=JSON.parse(u["oae-ui"].skin.variables)),e.each(t.results,function(t,n){e.each(n.subsections,function(t,n){e.each(n.variables,function(e,t){t.value=r[t.name]||t.defaultValue,a[t.name]=t.defaultValue})})}),n.api.util.template().render(e("#admin-skinning-template"),t,e("#admin-skinning-container")),e('[data-type="color"]').spectrum({preferredFormat:"rgb",showAlpha:!0,showButtons:!1,showInitial:!0,showInput:!0})}})},L=function(){var t=e("#admin-skinning-form input"),n={};return e.each(t,function(r,i){var s=e(i).attr("name"),o=e(i).attr("data-type");if(o==="color"){var u=a[s],f=e(t[r]).val();tinycolor.equals(u,f)||(n[s]=f)}else{var l=a[s],c=e.trim(e(t[r]).val());l!==c&&(n[s]=c)}}),n},A=function(){var t={"oae-ui/skin/variables":JSON.stringify(L())},r="/api/config";return i.isTenantOnGlobalAdminServer&&(r+="/"+i.alias),e.ajax({url:r,type:"POST",data:t,success:function(){n.api.util.notification("Skin saved.","The skin has been successfully saved.")},error:function(){n.api.util.notification("Skin not saved.","The skin could not be saved successfully.","error")}}),!1},O=function(){var t=e("input",e(this).parent()),n=t.attr("data-defaultvalue");t.attr("data-type")==="color"?t.spectrum("set",n):t.val(n)},M=function(){D(function(){R(),I()})},_=function(t){e.ajax({url:"/api/config/schema",success:function(n){o=n,delete o["oae-ui"];var r="/api/config";i.isTenantOnGlobalAdminServer&&(r+="/"+i.alias),e.ajax({url:r,success:function(e){u=e,t()}})}})},D=function(t){e.ajax({url:"/api/tenants",success:function(e){s=e,t()}})},P=function(t){e.ajax({url:"/api/tenant",success:function(n){i=n;var r=e.url().segment(2);r&&(i=s[r],i.isTenantOnGlobalAdminServer=!0),t()}})},H=function(){n.api.util.template().render(e("#admin-lhnav-template"),{context:i},e("#admin-lhnav-container")),e("#admin-lhnav-container").show();var t=e.url().param().view;History.replaceState({view:t,_:Math.random()},e("title").text(),History.getState().cleanUrl)},B=function(){return History.pushState({view:e(this).attr("data-id")},e("title").text(),e("a",e(this)).attr("href")),!1},j=function(){e(document).on("click","#admin-header-user-logout",T),e(document).on("click","#createtenant-toggle-button",f),e(document).on("click",".admin-module-configuration-toggle-button",f),e(document).on("click",".stop-tenant",w),e(document).on("click",".stop-all-tenants",y),e(document).on("click",".start-tenant",E),e(document).on("click",".start-all-tenants",g),e(document).on("click",".delete-tenant",b),e(document).on("click",".login-tenant",N),e(document).on("submit",".admin-module-configuration-form",h),e(document).on("click",".admin-skinning-revert",O),e(document).on("submit","#admin-skinning-form",A),e(document).on("click","#admin-lhnav-container ul li",B),e(window).on("statechange",c)},F=function(){n.api.util.template().render(e("#admin-header-template"),{context:i},e("#admin-header-container")),i.isGlobalAdminServer?n.api.util.setBrowserTitle("Global Administration"):n.api.util.setBrowserTitle("Tenant Administration")},I=function(){n.api.util.template().render(e("#admin-footer-template"),{context:i,tenants:s},e("#admin-footer-container"))},q=function(){n.api.util.template().render(e("#admin-modules-template"),{schema:o,configuration:u,context:i},e("#admin-modules-container"))},R=function(){var r=i.isGlobalAdminServer?s:[i],o=t.find(s,function(e){return!e.active});n.api.util.template().render(e("#admin-tenants-template"),{tenants:r,hasStoppedServer:o,context:i},e("#admin-tenants-container")),l(),n.api.util.validation().validate(e("#createtenant-form"),{submitHandler:p})},U=function(){if(!n.data.me.anon&&!n.data.me.isTenantAdmin&&!n.data.me.isGlobalAdmin)return n.api.util.redirect().accessdenied();D(function(){P(function(){F(),I(),n.data.me.anon?S():_(function(){H(),R(),q(),k()})})})};j(),U()});