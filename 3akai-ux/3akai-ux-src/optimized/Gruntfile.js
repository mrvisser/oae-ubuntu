var _=require("underscore"),shell=require("shelljs"),util=require("util"),vm=require("vm");module.exports=function(e){e.initConfig({pkg:"<json:package.json>",meta:{banner:'/*! <%= pkg.name %> - v<%= pkg.version %> - <%= grunt.template.today("yyyy-mm-dd") %>\n<%= pkg.homepage ? "* " + pkg.homepage + "\n" : "" %>* Copyright (c) <%= grunt.template.today("yyyy") %> <%= pkg.author.name %>; Licensed <%= _.pluck(pkg.licenses, "type").join(", ") %> */'},qunit:{index:["tests/qunit/tests/unit/*.html"]},lint:{files:["grunt.js","admin/**/*.js","shared/**/*.js","ui/**/*.js","node_modules/oae-*/**/*.js"]},watch:{files:"<config:lint.files>",tasks:"lint test"},jshint:{options:{sub:!0},globals:{exports:!0,module:!1}},clean:{folder:"target/"},copy:{main:{files:[{expand:!0,src:["**","!target/**","!tests/**","!tools/**","!node_modules/.*/**","!node_modules/grunt*/**","!node_modules/shelljs/**","!node_modules/underscore/**"],dest:"target/original"}]}},requirejs:{optimize:{options:{appDir:"./",baseUrl:"./shared",mainConfigFile:"./shared/oae/api/oae.bootstrap.js",dir:"target/optimized",optimize:"uglify",preserveLicenseComments:!1,optimizeCss:"standard",cssImportIgnore:null,inlineText:!0,useStrict:!1,pragmas:{},skipPragmas:!1,skipModuleInsertion:!1,modules:[{name:"oae.core",exclude:["jquery"]}],fileExclusionRegExp:/^(\.|target|tests|tools|grunt|shelljs|underscore$)/,logLevel:2}}},ver:{oae:{basedir:"target/optimized",phases:[{folders:["target/optimized/shared/bundles","target/optimized/ui/bundles","target/optimized/admin/bundles","target/optimized/shared/vendor/js/l10n/cultures"],files:_hashFiles(["target/optimized/shared","target/optimized/ui","target/optimized/admin","target/optimized/docs"],["html","json","ico","less"],["!target/optimized/shared/vendor/js/l10n/cultures.*/**","!target/optimized/ui/bundles.*/**","target/optimized/shared/oae/macros/*.html"]),references:["target/optimized/shared/**/*.html","target/optimized/shared/**/*.js","target/optimized/shared/**/*.css","target/optimized/ui/**/*.html","target/optimized/ui/**/*.js","target/optimized/ui/**/*.css","target/optimized/admin/**/*.html","target/optimized/admin/**/*.js","target/optimized/admin/**/*.css","target/optimized/docs/**/*.html","target/optimized/docs/**/*.js","target/optimized/docs/**/*.css","target/optimized/node_modules/oae-*/**/*.html","target/optimized/node_modules/oae-*/**/*.js","target/optimized/node_modules/oae-*/**/*.css","target/optimized/node_modules/oae-*/**/*.json"]}],version:"target/optimized/hashes.json"}},"git-describe":{oae:{}}}),e.loadNpmTasks("grunt-contrib-clean"),e.loadNpmTasks("grunt-contrib-copy"),e.loadNpmTasks("grunt-git-describe"),e.loadNpmTasks("grunt-ver"),e.loadNpmTasks("grunt-contrib-requirejs"),e.registerTask("writeVersion",function(){this.requires("git-describe");var t=e.template.process('{"oae:ux-version":"<%= meta.version %>"}');e.file.write("target/optimized/ui/version.json",t)}),e.registerTask("configNginx",function(){var t="./nginx/nginx.json";if(shell.test("-f",t)){var n=require(t),r=e.file.read("./nginx/nginx.conf");e.config.set("nginxConf",n);var i=e.template.process(r),s="./target/optimized/nginx/nginx.conf";e.file.write(s,i),e.log.writeln("nginx.conf rendered at ".green+s.green)}else{var o="No "+t+" found, not rendering nginx.conf template";e.log.writeln(o.yellow)}}),e.registerTask("hashFiles",function(){this.requires("requirejs");var t=e.file.expand({filter:"isDirectory"},"target/optimized/node_modules/oae-*/*");t.forEach(function(t){e.log.writeln(t);var n={folders:[t+"/bundles"],files:_hashFiles([t],["json"]),references:[t+"/**/*.html",t+"/**/*.js",t+"/**/*.css",t+"/*.json"]};e.config.set("ver."+t+".basedir",t),e.config.set("ver."+t+".phases",[n]),e.task.run("ver:"+t)}),e.task.run("ver:oae"),e.task.run("updateBootstrapPaths")}),e.registerTask("updateBootstrapPaths",function(){this.requires("ver:oae");var t="target/optimized/",n=require("./"+e.config.get("ver.oae.version")),r=t+n["/shared/oae/api/oae.bootstrap.js"],i=e.file.read(r),s=/("|')?paths("|')?: ?\{[^}]*\}/,o="paths = {"+i.match(s)[0]+"}",u=vm.runInThisContext(o).paths;Object.keys(u).forEach(function(e){var t="/shared/",r=t+u[e]+".js",i="";n[r]&&(i=n[r],u[e]=i.substring(t.length,i.length-3))}),i=i.replace(s,"paths:"+JSON.stringify(u)),e.file.write(r,i),e.log.writeln("Boots strapped".green)}),e.registerTask("copyReleaseArtifacts",function(t){if(!t)return e.log.writeln("Please provide a path where the release files should be copied to".red);shell.mkdir("-p",t),shell.cp("-R",["./target/*","./README.md","./LICENSE","./COMMITTERS.txt"],t)}),e.registerTask("release",function(t){if(!t)return e.log.writeln("Please provide a path where the release files should be copied to".red);e.task.run("default"),e.task.run("copyReleaseArtifacts:"+t)}),e.registerTask("test",["qunit"]),e.registerTask("default",["clean","copy","git-describe","requirejs","hashFiles","writeVersion","configNginx"])};var _hashFiles=function(e,t,n){t=t||[];var r=[];return e.forEach(function(e){r.push(util.format("%s/**",e)),t.forEach(function(t){r.push(util.format("!%s/*.%s",e,t)),r.push(util.format("!%s/**/*.%s",e,t))})}),n?_.union(r,n):r};