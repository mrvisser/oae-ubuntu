(function(e){e.fn.autoSuggest=function(t,n){function s(e){var t=0;for(k in e)e.hasOwnProperty(k)&&t++;return t}function o(){var t=i.extraParams;return e.isFunction(t)?t():t}var r={asHtmlID:!1,startText:"Enter Name Here",usePlaceholder:!1,emptyText:"No Results Found",preFill:{},limitText:"No More Selections Are Allowed",selectedItemProp:"value",selectedValuesProp:"value",searchObjProps:"value",queryParam:"q",retrieveLimit:!1,extraParams:"",matchCase:!1,minChars:1,keyDelay:400,resultsHighlight:!0,neverSubmit:!1,scroll:!1,selectionLimit:!1,showResultList:!0,showResultListWhenNoMatch:!1,canGenerateNewSelections:!0,start:function(){},selectionClick:function(e){},selectionAdded:function(e){},selectionRemoved:function(e){e.remove()},formatList:!1,beforeRetrieve:function(e){return e},retrieveComplete:function(e){return e},resultClick:function(e){},resultsComplete:function(){}},i=e.extend(r,n),u,a=null;typeof t=="function"?u=t:typeof t=="string"?u=function(n,r){var s="";i.retrieveLimit&&(s="&limit="+encodeURIComponent(i.retrieveLimit)),a=e.getJSON(t+"?"+i.queryParam+"="+encodeURIComponent(n)+s+o(),function(e){var t=i.retrieveComplete.call(this,e);r(t,n)})}:typeof t=="object"&&s(t)>0&&(u=function(e,n){n(t,e)});if(u)return this.each(function(t){function L(){var e=r.val().replace(/[\\]+|[\/]+/g,"");if(e==x)return;x=e,e.length>=i.minChars?(f.addClass("loading"),A(e)):(f.removeClass("loading"),c.hide())}function A(e){i.beforeRetrieve&&(e=i.beforeRetrieve.call(this,e)),P(),u(e,M)}function M(t,n){i.matchCase||(n=n.toLowerCase()),n=n.replace("(","\\(","g").replace(")","\\)","g");var u=0;c.html(h.html("")).hide();var a=s(t);for(var l=0;l<a;l++){var d=l;O++;var v=!1;if(i.searchObjProps=="value")var m=t[d].value;else{var m="",g=i.searchObjProps.split(",");for(var y=0;y<g.length;y++){var b=e.trim(g[y]);m=m+t[d][b]+" "}}m&&(i.matchCase||(m=m.toLowerCase()),m.search(n)!=-1&&p.val().search(","+t[d][i.selectedValuesProp]+",")==-1&&(v=!0));if(v){var w=e('<li class="as-result-item" id="as-result-item-'+d+'"></li>').click(function(){var t=e(this).data("data"),n=t.num;if(e("#as-selection-"+n,f).length<=0&&!N){var s=t.attributes;r.val("").focus(),x="",_(s,n),i.resultClick.call(this,t),c.hide()}N=!1}).mousedown(function(){o=!1}).mouseover(function(){e("li",h).removeClass("active"),e(this).addClass("active")}).data("data",{attributes:t[d],num:O}),E=e.extend({},t[d]);if(!i.matchCase)var S=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+n+")(?![^<>]*>)(?![^&;]+;)","gi");else var S=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+n+")(?![^<>]*>)(?![^&;]+;)","g");i.resultsHighlight&&n.length>0&&(E[i.selectedItemProp]=E[i.selectedItemProp].replace(S,"<em>$1</em>")),i.formatList?w=i.formatList.call(this,E,w):w=w.html(E[i.selectedItemProp]),h.append(w),delete E,u++;if(i.retrieveLimit&&i.retrieveLimit==u)break}}f.removeClass("loading"),u<=0&&h.html('<li class="as-message">'+i.emptyText+"</li>"),h.css("width",f.outerWidth()),i.scroll&&h.css({"max-height":i.scroll,"overflow-y":"auto"}),(u>0||!i.showResultListWhenNoMatch)&&c.show(),i.resultsComplete.call(this)}function _(t,n){p.val((p.val()||",")+t[i.selectedValuesProp]+",");var s=e('<li class="as-selection-item" id="as-selection-'+n+'" data-value="'+t[i.selectedValuesProp]+'"></li>').click(function(){i.selectionClick.call(this,e(this)),f.children().removeClass("selected"),e(this).addClass("selected")}).mousedown(function(){o=!1}),u=e('<a class="as-close">&times;</a>').click(function(){return p.val(p.val().replace(","+t[i.selectedValuesProp]+",",",")),i.selectionRemoved.call(this,s),o=!0,r.focus(),!1});return l.before(s.html(t[i.selectedItemProp]).prepend(u)),s.data("originalData",t),i.selectionAdded.call(this,l.prev(),t[i.selectedValuesProp]),l.prev()}function D(t){if(e(":visible",c).length>0){var n=e("li",c);if(t=="down")var r=n.eq(0);else var r=n.filter(":last");var s=e("li.active:first",c);s.length>0&&(t=="down"?r=s.next():r=s.prev()),n.removeClass("active"),r.addClass("active"),i.scroll&&r.length&&(r.position().top+r.height()>e(h).height()||r.position().top<0)&&e(h).scrollTop(e(h).scrollTop()+r.position().top)}}function P(){a&&(a.abort(),a=null)}if(!i.asHtmlID){t=t+""+Math.floor(Math.random()*100);var n="as-input-"+t}else{t=i.asHtmlID;var n=t}i.start.call(this,{add:function(t){_(t,"u"+e("li",f).length).addClass("blur")},remove:function(e){p.val(p.val().replace(","+e+",",",")),f.find('li[data-value = "'+e+'"]').remove()}});var r=e(this);r.attr("autocomplete","off").addClass("as-input").attr("id",n),i.usePlaceholder?r.attr("placeholder",i.startText):r.val(i.startText);var o=!1;r.wrap('<ul class="as-selections" id="as-selections-'+t+'"></ul>').wrap('<li class="as-original" id="as-original-'+t+'"></li>');var f=e("#as-selections-"+t),l=e("#as-original-"+t),c=e('<div class="as-results" id="as-results-'+t+'"></div>').hide(),h=e('<ul class="as-list"></ul>'),p=e('<input type="hidden" class="as-values" name="as_values_'+t+'" id="as-values-'+t+'" />'),d="";if(typeof i.preFill=="string"){var v=i.preFill.split(",");for(var m=0;m<v.length;m++){var g={};g[i.selectedValuesProp]=v[m],v[m]!=""&&_(g,"000"+m)}d=i.preFill}else{d="";var y=0;for(k in i.preFill)i.preFill.hasOwnProperty(k)&&y++;if(y>0)for(var m=0;m<y;m++){var b=i.preFill[m][i.selectedValuesProp];b==undefined&&(b=""),d=d+b+",",b!=""&&_(i.preFill[m],"000"+m)}}if(d!=""){r.val("");var w=d.substring(d.length-1);w!=","&&(d+=","),p.val(","+d),e("li.as-selection-item",f).addClass("blur").removeClass("selected")}r.after(p),f.click(function(){o=!0,r.focus()}).mousedown(function(){o=!1}).after(c);var E=null,S=null,x="",T=0,N=!1,C=null;r.focus(function(){return!i.usePlaceholder&&e(this).val()==i.startText&&p.val()==""?e(this).val(""):o&&(e("li.as-selection-item",f).removeClass("blur"),e(this).val()!=""&&(h.css("width",f.outerWidth()),c.show())),E&&clearInterval(E),E=setInterval(function(){i.showResultList&&(i.selectionLimit&&e("li.as-selection-item",f).length>=i.selectionLimit?(h.html('<li class="as-message">'+i.limitText+"</li>"),c.show()):L())},i.keyDelay),o=!0,i.minChars==0&&A(e(this).val()),!0}).blur(function(){!i.usePlaceholder&&e(this).val()==""&&p.val()==""&&d==""&&i.minChars>0?e(this).val(i.startText):o&&(e("li.as-selection-item",f).addClass("blur").removeClass("selected"),c.hide()),E&&clearInterval(E)}).keydown(function(t){C=t.keyCode,first_focus=!1;switch(t.keyCode){case 38:t.preventDefault(),D("up");break;case 40:t.preventDefault(),D("down");break;case 8:if(r.val()==""){var n=p.val().split(",");n=n[n.length-2],f.children().not(l.prev()).removeClass("selected"),l.prev().hasClass("selected")?(p.val(p.val().replace(","+n+",",",")),i.selectionRemoved.call(this,l.prev())):(i.selectionClick.call(this,l.prev()),l.prev().addClass("selected"))}r.val().length==1&&(c.hide(),x="",P()),e(":visible",c).length>0&&(S&&clearTimeout(S),S=setTimeout(function(){L()},i.keyDelay));break;case 9:case 188:var s=e("li.active:first:visible",c);if(s.length===0){if(i.canGenerateNewSelections){N=!0;var o=r.val().replace(/(,)/g,"");if(o!==""&&p.val().search(","+o+",")<0&&o.length>=i.minChars){t.preventDefault();var u={};u[i.selectedItemProp]=o,u[i.selectedValuesProp]=o;var a=e("li",f).length;_(u,"00"+(a+1)),r.val(""),P()}}break};case 13:N=!1;var s=e("li.active:first",c);s.length>0&&(s.click(),c.hide()),(i.neverSubmit||s.length>0)&&t.preventDefault();break;case 27:case 16:case 20:P(),c.hide()}});var O=0})}})(jQuery);