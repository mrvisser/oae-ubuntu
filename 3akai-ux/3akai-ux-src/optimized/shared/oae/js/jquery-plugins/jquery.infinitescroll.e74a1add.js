define(["jquery","underscore","oae.api.util","oae.api.i18n"],function(e,t,n,r){(function(e){e.fn.infiniteScroll=function(i,s,o,u){if(!i)throw new Error("A valid source URL should be provided");if(!o)throw new Error("A valid template name or render function should be provided");s=s||{},u=u||{},s.limit=s.limit||10,t.isString(o)&&(o=e(o)),u.scrollContainer&&(u.scrollContainer=e(u.scrollContainer));var a=e("<div />").addClass("text-center hide").css("clear","both"),f=u.scrollContainer?u.scrollContainer:e(this),l=!1,c=!1,h=function(){u.scrollContainer?u.scrollContainer.scroll(p):e(window).scroll(p)},p=function(){if(!c&&f){var t=500,n=e(document).height()-e(window).height()-e(window).scrollTop();u.scrollContainer&&(t=200,n=u.scrollContainer.prop("scrollHeight")-u.scrollContainer.height()-u.scrollContainer.scrollTop()),n<=t&&f.is(":visible")&&d()}},d=function(){c=!0,E();var t=f.children("li").filter(":visible").filter(":last");t.length!==0&&l===!0&&(s.start=t.attr("data-key")?t.attr("data-key"):t.index()+1),e.ajax({url:i,data:s,success:function(e){l=!0,v(e)},error:function(){S(),console.error("An error has occured while retrieving the list of results")}})},v=function(e,t){u.postProcessor&&(e=u.postProcessor(e)),m(e,t)},m=function(r,i){var a=r.results.length===s.limit||i;if(f){S();var l="";t.isFunction(o)?l=o(r.results):l=n.template().render(o,r);var h=e("<div>").html(l);h.children().each(function(t,n){var r=e(n).attr("data-id"),s=e('li[data-id="'+r+'"]',f);r&&(i?s.remove():s.length>0&&e(n).remove())}),l=h.html(),i?f.prepend(l):f.append(l),u.postRenderer&&u.postRenderer(r),a?setTimeout(function(){c=!1,p()},1e3):(c=!0,e("li",f).length===0&&u.emptyListProcessor&&u.emptyListProcessor())}},g=function(){u.initialContent&&(t.isFunction(u.initialContent)?f.prepend(u.initialContent()):f.prepend(u.initialContent))},y=function(e){v({results:e},!0)},b=function(n){t.isArray(n)||(n=[n]);var r=0;e.each(n,function(t,i){$item=e('[data-id="'+i+'"]',f),$item.fadeOut(!1,function(){e(this).remove(),r++,r===n.length&&p()})})},w=function(){f.html(""),a.remove(),c=!0,f=null},E=function(){a.show()},S=function(){a.hide()},x=function(){var t=e("<i />").addClass("icon-spinner icon-spin"),n=e("<span />").text(r.translate("__MSG__LOADING__")).addClass("oae-aural-text");t.append(n),a.append(t),a.insertAfter(f)};return f.attr("aria-live","assertive"),x(),g(),d(),h(),{prependItems:y,removeItems:b,kill:w}}})(e)});