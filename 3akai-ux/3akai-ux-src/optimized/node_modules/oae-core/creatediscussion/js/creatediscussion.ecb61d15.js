define(["jquery","oae.core"],function(e,t){return function(n){var r=e("#"+n),i=t.api.config.getValue("oae-discussions","visibility","discussion"),s=[],o=function(){e("#creatediscussion-modal",r).on("hidden",function(n){var i=e("#creatediscussion-form",r);i[0].reset(),t.api.util.validation().clear(i),f()})},u=function(){var n={submitHandler:c};t.api.util.validation().validate(e("#creatediscussion-form",r),n)},a=function(){e(".modal-body > div:visible",r).hide(),e("#creatediscussion-form > .modal-footer",r).hide(),e("#creatediscussion-permissions-container",r).show()},f=function(){e(".modal-body > div:visible",r).hide(),e("#creatediscussion-form > .modal-footer",r).show(),e("#creatediscussion-overview-container",r).show()},l=function(){var n=e("#creatediscussion-permissions-container",r);n.html("");var o=t.api.util.generateId();e(document).on("oae.setpermissions.changed."+o,function(t,n){i=n.visibility,e(n.viewers).each(function(e,t){s.push(t.id)}),e("#creatediscussion-permissions-summary",r).html(n.summary),f()}),e(document).on("oae.setpermissions.cancel."+o,f),t.api.widget.insertWidget("setpermissions",o,n,!1,{count:1,type:"discussion",visibility:i})},c=function(){e("#creatediscussion-form *",r).prop("disabled",!0);var n=e.trim(e("#creatediscussion-name",r).val()),o=e.trim(e("#creatediscussion-topic",r).val());return t.api.discussion.createDiscussion(n,o,i,[],s,function(e,n){e?t.api.util.notification(t.api.i18n.translate("__MSG__DISCUSSION_NOT_CREATED__","creatediscussion"),t.api.i18n.translate("__MSG__DISCUSSION_COULD_NOT_BE_CREATED__","creatediscussion"),"error"):window.location=n.profilePath}),!1},h=function(){e(document).on("click",".oae-trigger-creatediscussion",function(){e("#creatediscussion-modal",r).modal({backdrop:"static"})}),e("#creatediscussion-modal",r).on("shown",function(){e("#creatediscussion-name",r).focus(),l()}),e("#creatediscussion-change-permissions",r).on("click",a)};h(),u(),o()}});