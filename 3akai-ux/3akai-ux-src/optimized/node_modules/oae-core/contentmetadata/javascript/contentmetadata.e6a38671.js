require(["jquery","sakai/sakai.api.core","/dev/javascript/content_profile.js"],function(e,t){sakai_global.contentmetadata=function(n,r){var i=e("#contentmetadata_description_container"),s=e("#contentmetadata_tags_container"),o=e("#contentmetadata_url_container"),u=e("#contentmetadata_copyright_container"),a=e("#contentmetadata_details_container"),f="#contentmetadata_description_display",l=e(".collapsible_container"),c="#contentmetadata_view_revisions",h=e(".contentmetadata_editable"),p=".contentmetadata_cancel_save",d=".contentmetadata_save",v=".contentmetadata_edit_input",m=!1,g=e("#contentmetadata_show_more"),y=e("#contentmetadata_see_more"),b=e("#contentmetadata_see_less"),w="contentmetadata_description_template",E="contentmetadata_tags_template",S="contentmetadata_url_template",x="contentmetadata_copyright_template",T="contentmetadata_details_template",N=e("#contentmetadata_updated_copyright"),C="openjedit.contentmetadata.sakai",k="",L="",A=function(n,r){n==="edit"&&(e(".contentmetadata_edit_input").length&&e(".contentmetadata_edit_input").focus(),r?t.api.Util.hideOnClickOut(e(".autosuggest_wrapper",s),"#assignlocation_container, "+s.selector+" .autosuggest_wrapper",function(){I(!1,"tags")}):e(v).blur(I))},O=function(e){sakai_global.content_profile.content_data.mode=e;var n={data:sakai_global.content_profile.content_data,sakai:t};i.toggleClass("contentmetadata_editing",e==="edit"),i.html(t.api.Util.TemplateRenderer(w,n)),A(e)},M=function(e){sakai_global.content_profile.content_data.mode=e,L=t.api.Content.getMimeType(sakai_global.content_profile.content_data);if(L==="x-sakai/link"){var n={data:sakai_global.content_profile.content_data,sakai:t};t.api.Util.TemplateRenderer(S,n,o),o.show(),s.removeClass("last")}else o.hide();A(e)},_=function(n){sakai_global.content_profile.content_data.mode=n;var r={data:sakai_global.content_profile.content_data,sakai:t,tags:t.api.Util.formatTags(sakai_global.content_profile.content_data.tags)};s.html(t.api.Util.TemplateRenderer(E,r)),s.toggleClass("contentmetadata_editing",n==="edit"),s.toggleClass("contentmetadata_editable",n!=="edit"),n==="edit"&&(m=e("#contentmetadata_tags_tags"),t.api.Util.AutoSuggest.setupTagAndCategoryAutosuggest(m,null,e(".list_categories",s),sakai_global.content_profile.content_data.tags,function(){e(".as-selections",s).addClass("contentmetadata_edit_input"),m.focus()})),A(n,!0)},D=function(e){sakai_global.content_profile.content_data.mode=e;var n={data:sakai_global.content_profile.content_data,sakai:t};u.toggleClass("contentmetadata_editing",e==="edit"),u.html(t.api.Util.TemplateRenderer(x,n)),A(e)},P=function(e){var n={data:sakai_global.content_profile.content_data,sakai:t,creator:sakai_global.content_profile.content_data.createdBy};t.api.Util.TemplateRenderer(T,n,a),A(e)},H=function(n){var r={"sakai:activityMessage":n};t.api.Activity.createActivity("/p/"+sakai_global.content_profile.content_data.contentId,"content","default",r,function(t,r){r&&e(window).trigger("updateContentActivity.entity.sakai",n)})},B=function(){var e=t.api.Util.AutoSuggest.getTagsAndCategories(m,!0),n=sakai_global.content_profile.content_data.contentId;t.api.Util.tagEntity("/p/"+n,e,sakai_global.content_profile.content_data.tags,function(e,t){n===sakai_global.content_profile.content_data.contentId&&(sakai_global.content_profile.content_data.tags=t,_(!1)),e&&H("UPDATED_TAGS")})},j=function(n){var r=sakai_global.content_profile.content_data.contentId;e.ajax({url:t.config.URL.POOLED_CONTENT_ITEM.replace("__CONTENTID__",r),type:"POST",cache:!1,data:{link:n},success:function(){H("UPDATED_URL"),e(window).trigger("updated.version.content.sakai")}})},F=function(t){t.stopPropagation(),e(t.target).is("a, select, option, textarea")||($target=e(t.target).closest(".contentmetadata_editable"),$target.length&&(k!==""&&I(!1,k),k=$target.attr("data-edit-field"),k==="tags"&&_("edit")))},I=function(e,t){if(!e&&t!==k)return;k==="tags"&&B(),k=""},q=function(e,n){if(n!==sakai_global.content_profile.content_data[e])switch(e){case"description":var r=sakai_global.content_profile.content_data.contentId;t.api.Content.updateContentItem(r,{description:n},function(e){e&&(sakai_global.content_profile.content_data.description=n,H("UPDATED_DESCRIPTION"))});break;case"copyright":R({"sakai:copyright":n},function(e){e&&(sakai_global.content_profile.content_data.copyright=n,H("UPDATED_COPYRIGHT"))});break;case"url":j(n)}},R=function(n,r){var i="/p/"+sakai_global.content_profile.content_data.contentId+".json";t.api.Server.saveJSON(i,n,function(t,n){e.isFunction(r)&&r(t)})},U=function(){l.animate({"margin-bottom":"toggle",height:"toggle",opacity:"toggle","padding-top":"toggle","padding-bottom":"toggle"},400),e("#contentmetadata_show_more > div").toggle(),L==="x-sakai/link"?o.toggleClass("last"):s.toggleClass("last")},z=function(){e(".contentmetadata_editable_for_maintainers").toggleClass("contentmetadata_editable",sakai_global.content_profile.content_data.isManager||sakai_global.content_profile.content_data.isEditor),g.off("click").on("click",U),e(".contentmetadata_editable").off("click").on("click",F),e(c).off("click").on("click",function(){e(window).trigger("initialize.filerevisions.sakai",sakai_global.content_profile.content_data)}),e(".contentmetadata_jedit.contentmetadata_editable").click(function(t){if(!e(".contentmetadata_edit_input",e(this)).find("textarea").length&&!e(".contentmetadata_edit_area_select",e(this)).find("select").length){if(e(this).attr("data-edit-field")==="url"){if(e(t.target).is("a"))return;var n=e(this).find(".contentmetadata_edit_input");n.html(e.trim(n.text()))}e(this).addClass("contentmetadata_editing"),e(".contentmetadata_edit_input, .contentmetadata_edit_area_select",e(this)).trigger(C)}});var n='<span class="contentmetadata_placeholder">',r="</span>",i=t.api.i18n.getValueForKey("CLICK_TO_EDIT_DESCRIPTION","contentmetadata"),s=t.api.i18n.getValueForKey("CLICK_TO_EDIT","contentmetadata"),o=function(t,n){var r=e(this).parents(".contentmetadata_jedit");r.length||(r=e(this)),r.removeClass("contentmetadata_editing");var i=r.attr("data-edit-field");return q(i,e.trim(t)),t};e(".contentmetadata_description_textarea").editable(o,{type:"textarea",onblur:"submit",event:C,tooltip:s,placeholder:n+i+r});var u={},a=!1;e.each(t.config.Permissions.Copyright.types,function(e,n){sakai_global.content_profile.content_data.copyright===e&&(a=e),u[e]=t.api.i18n.getValueForKey(n.title,"contentmetadata")}),a&&(u.selected=a);var f=function(t,n){e(this).html(n.data[t]),u.selected=t};e(".contentmetadata_edit_area_select").editable(o,{data:u,type:"select",onblur:"submit",event:C,callback:f,tooltip:s});var l=t.api.i18n.getValueForKey("CLICK_TO_EDIT_URL","contentmetadata"),h=function(t,n){if(e(this).text()){var r='<a class="oae-action" target="_blank" href="'+e(this).text()+'">'+e(this).text()+"</a>";e(this).html(r)}};e(".contentmetadata_url_textarea").editable(o,{type:"textarea",onblur:"submit",event:C,callback:h,placeholder:n+l+r})},W=function(){O(!1),_(!1),M(!1),D(!1),P(!1),z()};e("input").on("keyup",function(t){t.keyCode===13&&e(this).blur()}),e(window).on("render.contentmetadata.sakai",function(){W()}),sakai_global.contentmetadata.isReady=!0,e(window).trigger("ready.contentmetadata.sakai")},t.api.Widgets.widgetLoader.informOnLoad("contentmetadata")});