define(["jquery","underscore","oae.core","//www.google.com/recaptcha/api/js/recaptcha_ajax.js"],function(e,t,n){return function(t,r){var i=e("#"+t),s=n.api.config.getValue("oae-principals","recaptcha","enabled"),o=function(){if(s){var t=e("#register-captcha-container",i)[0];Recaptcha.create(n.api.config.getValue("oae-principals","recaptcha","publicKey"),t,{theme:"clean"})}},u=function(){e("#recaptcha_response_field",i).attr({"aria-invalid":"true","aria-describedby":"register-captcha-error"}),e("#register-captcha",i).addClass("error"),e("#register-captcha-error",i).show()},a=function(){e("#recaptcha-response-field",i).removeAttr("aria-invalid aria-describedby"),e("#register-captcha-error",i).hide(),e("#register-captcha",i).removeClass("error")},f=function(){var t="";e("#register-username",i).on("keyup blur",function(){var n=e.trim(e(this).val());t!==n&&(t=n,n.length>2&&n.indexOf(" ")===-1?l(n,function(t){t?e("#register-username-available",i).removeClass("icon-remove").addClass("icon-ok"):e("#register-username-available",i).removeClass("icon-ok").addClass("icon-remove")}):e("#register-username-available",i).removeClass("icon-ok").addClass("icon-remove"))})},l=function(t,n){var r=!1;return e.ajax({url:"/api/auth/exists/"+t,async:n?!0:!1,success:function(){n&&n(!1)},error:function(e,t,i){n?n(!0):r=!0}}),r};setUpValidation=function(){var t={rules:{username:{minlength:3,nospaces:!0,validchars:!0,validusername:!0},password:{minlength:6},password_repeat:{equalTo:"#register-password"}},messages:{firstName:{required:n.api.i18n.translate("__MSG__PLEASE_ENTER_YOUR_FIRST_NAME__","register")},lastName:{required:n.api.i18n.translate("__MSG__PLEASE_ENTER_YOUR_LAST_NAME__","register")},email:{required:n.api.i18n.translate("__MSG__PLEASE_ENTER_A_VALID_EMAIL_ADDRESS__","register"),email:n.api.i18n.translate("__MSG__THIS_IS_AN_INVALID_EMAIL_ADDRESS__","register")},username:{required:n.api.i18n.translate("__MSG__PLEASE_ENTER_YOUR_USERNAME__"),minlength:n.api.i18n.translate("__MSG__THE_USERNAME_SHOULD_BE_AT_LEAST_THREE_CHARACTERS_LONG__","register"),nospaces:n.api.i18n.translate("__MSG__THE_USERNAME_SHOULDNT_CONTAIN_SPACES__","register")},password:{required:n.api.i18n.translate("__MSG__PLEASE_ENTER_YOUR_PASSWORD__"),minlength:n.api.i18n.translate("__MSG__YOUR_PASSWORD_SHOULD_BE_AT_LEAST_SIX_CHARACTERS_LONG__")},password_repeat:{required:n.api.i18n.translate("__MSG__PLEASE_REPEAT_YOUR_PASSWORD__"),passwordmatch:n.api.i18n.translate("__MSG__THIS_PASSWORD_DOES_NOT_MATCH_THE_FIRST_ONE__")}},methods:{validusername:{method:function(t,n){return this.optional(n)||l(e.trim(t))},text:n.api.i18n.translate("__MSG__THIS_USERNAME_HAS_ALREADY_BEEN_TAKEN__","register")},validchars:{method:function(e,t){return this.optional(t)||!/[\<\>\\\/{}\[\]!@#\$%^&\*,:]+/i.test(e)},text:n.api.i18n.translate("__MSG__CREATE_ACCOUNT_INVALIDCHAR__","register")}},submitHandler:c};n.api.util.validation().validate(e("#register-form",i),t)};var c=function(){a();var t=e("#register-form").serializeObject();s&&(t.recaptchaChallenge=Recaptcha.get_challenge(),t.recaptchaResponse=Recaptcha.get_response()),e("button, input",i).prop("disabled",!0);var r=t.firstName+" "+t.lastName,o={email:t.email};n.api.user.createUser(t.username,t.password,r,o,t.recaptchaChallenge,t.recaptchaResponse,function(r,o){r?(s&&(Recaptcha.reload(),u()),e("button, input",i).prop("disabled",!1)):n.api.authentication.login(t.username,t.password,function(){window.location="/me"})})},h=function(){e(document).on("click",".oae-trigger-register",function(){e("#register-modal",i).modal({backdrop:"static"}),e("#register-modal",i).on("shown",function(){e("#register-firstname",i).focus()})})};h(),o(),setUpValidation(),f()}});