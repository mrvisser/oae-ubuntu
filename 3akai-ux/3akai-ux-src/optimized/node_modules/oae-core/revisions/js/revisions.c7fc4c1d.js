define(["jquery","oae.core"],function(e,t){return function(n,r){var i=e("#"+n),s=!1,o=null,u=!1,a={},f=function(t){var n=e(t.target);n.hasClass("well")||(n=e(e(t.target).parents("li")));var r=n.attr("data-revisionid");return{etherpadHtml:a[r],mediumUrl:n.attr("data-mediumurl"),resourceType:o.resourceType,resourceSubType:n.attr("data-resourcesubtype"),revisionId:r}},l=function(n){var r=f(n);e(".oae-list li",i).removeClass("selected"),e(n.currentTarget).addClass("selected"),t.api.util.template().render(e("#revisions-preview-template",i),{revision:r},e("#revisions-preview",i))},c=function(n){var r=f(n);t.api.content.restoreRevision(o.id,r.revisionId,function(n,r){n?t.api.util.notification(t.api.i18n.translate("__MSG__REVISION_NOT_RESTORED__","revisions"),t.api.i18n.translate("__MSG__REVISION_RESTORE_FAIL__","revisions"),"error"):(e("#revisions-modal",i).modal("hide"),t.api.util.notification(t.api.i18n.translate("__MSG__REVISION_RESTORED__","revisions"),t.api.i18n.translate("__MSG__REVISION_RESTORE_SUCCESS__","revisions")),t.api.content.getContent(o.id,function(t,n){e(document).trigger("oae.revisions.done",[r,n])}))})},h=function(){s&&s.kill(),u=!1;var n="/api/content/"+o.id+"/revisions";s=e(".oae-list",i).infiniteScroll(n,{limit:8},"#revisions-list-template",{postProcessor:function(n){return o.resourceSubType==="collabdoc"&&e.each(n,function(e,n){t.api.util.isBlank(n.etherpadHtml)||(a[n.revisionId]=n.etherpadHtml)}),{results:n,resourceSubType:o.resourceSubType}},postRenderer:function(){u||(u=!0,e(".oae-list li:first-child",i).click())},scrollContainer:e(".oae-list",i)})},p=function(t){var n=e(t.currentTarget);t.which===40?(t.preventDefault(),n.next().length&&(n.next().click(),n.next().focus())):t.which===38&&(t.preventDefault(),n.prev().length&&(n.prev().click(),n.prev().focus()))},d=function(){e(document).on("click",".oae-trigger-revisions",function(){e("#revisions-modal",i).modal({backdrop:"static"}),e(document).trigger("oae.context.get","revisions")}),e(document).on("oae.context.send.revisions",function(e,t){o=t,h()}),i.on("click",".oae-list li",l),i.on("focus",".oae-list li",l),i.on("keydown",".oae-list li",p),i.on("click",".revisions-list-actions-restore",c)};d()}});