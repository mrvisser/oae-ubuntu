define(["jquery","oae.core"],function(e,t){return function(n,r){var i=e("#"+n),s=null,o=null,u=function(n,r){r.replyTo?e('li.media[data-id="'+r.replyTo+'"]',i).after(t.api.util.template().render("#comments-comment-template",{results:[r],canManage:s.isManager})):e("#comments-container li:first-child",i).after(t.api.util.template().render("#comments-comment-template",{results:[r],canManage:s.isManager})),c()},a=function(n){e('li.media[data-id="'+n.created+'"]').replaceWith(t.api.util.template().render("#comments-comment-template",{results:[n],canManage:s.isManager}))},f=function(n){var r=e(n),i=e.trim(r.find("textarea").val());return t.api.comment.createComment(s.id,s.resourceType,i,null,u),r[0].reset(),!1},l=function(n){var r=e(n),i=r.attr("data-replyTo"),o=e.trim(r.find("textarea").val());return t.api.comment.createComment(s.id,s.resourceType,o,i,u),r[0].reset(),r.parents(".comments-reply-container").hide(),!1},c=function(){t.api.util.validation().validate(e('.comments-new-comment-form[novalidate!="novalidate"]',i),{submitHandler:f}),e('.comments-new-reply-form[novalidate!="novalidate"]',i).each(function(n,r){t.api.util.validation().validate(e(r),{submitHandler:l})})},h=function(){i.on("click",".comments-reply-button",function(){var t=e(this).parent().siblings(".comments-reply-container");t.toggle(),t.find("textarea").focus()})},p=function(){i.on("click",".comments-delete-button",function(){var n=e(this).attr("data-id");t.api.comment.deleteComment(s.id,s.resourceType,n,function(e,t){if(e)throw new Error("Comment could not be deleted.");t?a(t):o.removeItems(n)})})},d=function(){t.data.me.anon||(e("#comments-container").prepend(t.api.util.template().render("#comments-new-comment-template")),e(document).on("click",".comments-focus-new-comment",function(){e(".comments-new-comment-form textarea").focus()}))},v=function(){o&&o.kill();var t="/api/"+s.resourceType+"/"+s.id+"/messages";o=e("#comments-container",i).infiniteScroll(t,null,e("#comments-comment-template"),{postProcessor:function(e){return e.canManage=s.isManager,e},postRenderer:c}),d(),h(),p()};e(document).on("oae.context.send.comments",function(e,t){s=t,v()}),e(document).trigger("oae.context.get","comments")}});