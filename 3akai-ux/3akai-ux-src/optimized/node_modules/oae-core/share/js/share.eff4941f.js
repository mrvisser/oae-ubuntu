define(["jquery","oae.core"],function(e,t){return function(n){var r=e("#"+n),i=null,s=null,o=null,u=null,a=function(){i.click()},f=function(){e(document).on("click","#share-save",function(){e("#share-save",r).prop("disabled",!0);var n=_.pluck(u,"id"),i=_.pluck(t.api.util.autoSuggest().getSelection(r),"id"),s=null;o==="content"?s=t.api.content.shareContent:o==="discussion"&&(s=t.api.discussion.shareDiscussion);var f=0,l=function(){s(n[f],i,function(s){f++;if(f===n.length){var c={count:n.length,err:s&&s.code===401,mylibrary:_.indexOf(i,t.data.me.id)!==-1,resourceType:o,resourceSubType:u[0].resourceSubType},h=t.api.util.template().render(e("#share-notification-title-template",r),c),p=t.api.util.template().render(e("#share-notification-body-template",r),c);t.api.util.notification(h,p,c.err?"error":"success"),a()}else l()})};l()})},l=function(){e("#share-save",r).prop("disabled",t.api.util.autoSuggest().getSelection(r).length?!1:!0)},c=function(){var n=[];if(!s||s.id!==t.data.me.id)o==="content"?n.push({id:t.data.me.id,displayName:t.api.i18n.translate("__MSG__MY_LIBRARY__")}):o==="discussion"&&n.push({id:t.data.me.id,displayName:t.api.i18n.translate("__MSG__MY_DISCUSSIONS__")});t.api.util.autoSuggest().setup(e("#share-autosuggest",r),{ghosts:n,selectionChanged:l},null,function(){t.api.util.autoSuggest().focus(r)})},h=function(){o=i.attr("data-resourceType"),i.attr("data-id")?(u=[{id:i.attr("data-id"),resourceSubType:i.attr("data-resourceSubType")}],c()):(e(document).on("oae.context.send.share",function(t,n){s=n,e(document).on("oae.list.sendSelection.share",function(e,t){u=t.results,c()}),e(document).trigger("oae.list.getSelection","share")}),e(document).trigger("oae.context.get","share"))},p=function(){e(document).on("click",".oae-trigger-share",function(){i=e(this),t.api.util.clickover(i,e(".share-widget"),{onShown:function(e){r=e,h()}})}),e(document).on("click","#share-cancel",a)};f(),p()}});