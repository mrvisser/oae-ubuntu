define(["jquery","oae.core","jquery.jcrop","jquery.fileupload","jquery.iframe-transport"],function(e,t){return function(n){var r=e("#"+n),i=!1,s={x:0,y:0,width:0,principalId:null},o=!e.support.xhrFileUpload&&!e.support.xhrFormDataFileUpload,u=function(){e("#changepic-pic-container",r).show(),t.api.util.template().render(e("#changepic-profile-picture-template",r),{pictureUrl:i.picture.medium},e("#changepic-pic-container",r)),v()},a=function(n){t.api.util.template().render(e("#changepic-jcrop-template",r),{pictureUrl:n.picture.large},e("#changepic-form #changepic-jcrop-container",r)),e("#changepic-uploading-container",r).hide(),e("#changepic-modal",r).modal("unlock"),e("#changepic-jcrop",r).on("load",function(n,i,s,o){n.currentTarget.naturalWidth<200||n.currentTarget.naturalHeight<200?(t.api.util.notification(t.api.i18n.translate("__MSG__PICTURE_IS_TOO_SMALL__","changepic"),t.api.i18n.translate("__MSG__PICTURE_YOU_TRIED_TO_UPLOAD_IS_TOO_SMALL__","changepic"),"error"),u()):(e("#changepic-modal",r).removeClass("changepic-initial-view"),e("#changepic-form #changepic-jcrop-container",r).show(),e(".modal-footer",r).show(),d())})},f=function(){e("#changepic-pic-container",r).hide(),e("#changepic-uploading-container",r).show(),e("#changepic-modal",r).modal("lock"),o?e("#changepic-uploading-container .icon-spinner",r).show():e("#changepic-uploading-container .progress",r).show()},l=function(t){e(".bar",r).css("width",t+"%")},c=function(t){var n=e("#changepic-jcrop",r)[0].naturalWidth,i=e("#changepic-jcrop",r)[0].naturalHeight,o=e("#changepic-jcrop",r).width(),u=e("#changepic-jcrop",r).height();widthScale=n/o,heightScale=i/u,s.x=Math.floor(t.x*widthScale),s.y=Math.floor(t.y*heightScale),s.width=Math.floor(t.w*widthScale)},h=function(){var t=e("#changepic-jcrop",r).width(),n=e("#changepic-jcrop",r).height(),i=0,s=0,o=0,u=0,a=Math.min(t,n)-40;return i=t/2-a/2,o=i+a,s=n/2-a/2,u=s+a,[i,s,o,u]},p=function(){e("#changepic-form #changepic-jcrop-container",r).hide(),e(".modal-footer",r).hide(),e("#changepic-cropping-container",r).show(),s.principalId=i.id,e("#changepic-modal",r).modal("lock"),e.ajax({url:"/api/crop",type:"POST",data:s,success:function(n){n.picture.small+="&"+t.api.util.generateId(),n.picture.medium+="&"+t.api.util.generateId(),n.picture.large+="&"+t.api.util.generateId(),e(document).trigger("oae.changepic.finished",n),e("#changepic-modal",r).modal("unlock"),e("#changepic-modal",r).modal("hide"),t.api.util.notification(t.api.i18n.translate("__MSG__PROFILE_PICTURE_UPDATED__","changepic"),t.api.i18n.translate("__MSG__PROFILE_PICTURE_SUCCESSFULLY_UPDATED__","changepic"))}})},d=function(){e("#changepic-jcrop",r).Jcrop({aspectRatio:1,bgOpacity:.4,bgColor:"#FFF",minSize:[50,50],setSelect:h(),onSelect:c})},v=function(){e(".changepic-dropzone-content i.icon-"+i.resourceType,r).removeClass("hide"),e("#changepic-form",r).fileupload()&&e("#changepic-form",r).fileupload("destroy");var n={url:"/api/"+i.resourceType+"/"+i.id+"/picture",dropZone:e("#changepic-dropzone",r),forceIframeTransport:o,progress:function(e,t){o||l(t.loaded/t.total*100)},add:function(e,n){var r=n.files[0].name.split(".").pop(),i=r.match(/(gif|jpe?g|png)$/i);i?(f(),n.submit()):t.api.util.notification(t.api.i18n.translate("__MSG__INVALID_IMAGE__","changepic"),t.api.i18n.translate("__MSG__SELECT_A_VALID_IMAGE__","changepic"),"error")},done:function(t,n){o?a(e.parseJSON(e(n.result[0]).text())):(l(100),a(e.parseJSON(n.result)))}};e("#changepic-form",r).fileupload(n)},m=function(){e("#changepic-modal",r).addClass("changepic-initial-view"),e("#changepic-form #changepic-jcrop-container",r).empty(),e(".modal-body > div",r).hide(),l(0),e(".modal-footer",r).hide()},g=function(){e("#changepic-set",r).on("click",p),e("#changepic-modal",r).on("hidden",m),e("#changepic-uploading-container .icon-spinner",r).hide()},y=function(){e(document).on("click",".oae-trigger-changepic",function(){e("#changepic-modal",r).modal({backdrop:"static"}),e(document).trigger("oae.context.get","changepic")}),e(document).on("oae.context.send.changepic",function(e,t){i=t,u()})};g(),y()}});