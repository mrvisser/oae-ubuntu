define(["jquery","oae.core","jquery.autosuggest"],function(e,t){return function(n){var r=e("#"+n),i=null,s={},o=null,u=null,a=function(e){i!==u.contextProfile.visibility?u.api.setVisibility(u.contextProfile.id,{visibility:i},e):e()},f=function(t){e.isEmptyObject(s)?t():u.api.setMembers(u.contextProfile.id,s,t)},l=function(){a(function(n){n||(u.contextProfile.visibility=i),f(function(i){n||i?t.api.util.notification(u.messages.accessNotUpdatedTitle,u.messages.accessNotUpdatedBody,"error"):(t.api.util.notification(u.messages.accessUpdatedTitle,u.messages.accessUpdatedBody),e(document).trigger("oae.manageaccess.done",u.contextProfile),e("#manageaccess-modal",r).modal("hide"))})})},c=function(){i===u.contextProfile.visibility&&e.isEmptyObject(s)?e("#manageaccess-overview-save",r).prop("disabled",!0):e("#manageaccess-overview-save",r).prop("disabled",!1)},h=function(){o&&o.kill();var t=u.api.getMembersURL;o=e(".oae-list",r).infiniteScroll(t,{limit:8},"#manageaccess-members-template",{scrollContainer:e("#manageaccess-overview-selected",r),postProcessor:function(e){return e.roles=u.roles,e}})},p=function(t){e.each(t,function(e,t){s[t.profile.id]=t.role}),o.prependItems(t),c()},d=function(){var t=e(this).attr("data-id");o.removeItems(t),s[t]=!1,c()},v=function(){var t=e(this).attr("data-id"),n=e(this).val();s[t]=n,c()},m=function(){e("#manageaccess-share-update",r).prop("disabled",y().length?!1:!0)},g=function(){t.api.util.autoSuggest().setup(e("#manageaccess-share-autosuggest",r),{selectionChanged:m},null,function(){t.api.util.autoSuggest().focus(r)})},y=function(){var n=[];return e.each(t.api.util.autoSuggest().getSelection(r),function(t,i){n.push({profile:i,role:e("#manageaccess-share-role",r).val()})}),n},b=function(t){e(".modal-body > div",r).hide(),e("#manageaccess-"+t,r).show(),e(".modal-footer > div",r).hide(),e("#manageaccess-"+t+"-footer",r).show()},w=function(){t.api.util.template().render(e("#manageaccess-visibility-template",r),{contextProfile:u.contextProfile,visibility:i,messages:u.messages},e("#manageaccess-visibility",r))},E=function(){t.api.util.template().render(e("#manageaccess-share-template",r),{contextProfile:u.contextProfile,roles:u.roles},e("#manageaccess-share",r)),g()},S=function(){t.api.util.template().render(e("#manageaccess-overview-visibility-template",r),{contextProfile:u.contextProfile,visibility:i,messages:u.messages},e("#manageaccess-overview-visibility-container",r))},x=function(){b("overview"),s={},e("#manageaccess-overview-save",r).prop("disabled",!0),e("#manageaccess-share-update",r).prop("disabled",!0)},T=function(t,n){u=n,i=u.contextProfile.visibility,e("#manageaccess-overview-shared-title",r).text(u.messages.membersTitle),e("#manageaccess-modal",r).modal({backdrop:"static"}),S(),h()},N=function(){e(document).on("oae.trigger.manageaccess",T),e(document).on("oae.trigger.manageaccess-add",function(e,t){T(e,t),b("share"),E()}),e("#manageaccess-modal",r).on("hidden",x)},C=function(){r.on("click","#manageaccess-change-visibility",function(){w(),b("visibility")}),r.on("click","#manageaccess-visibility-save",function(){i=e('.oae-large-options-container input[type="radio"]:checked',r).val(),S(),b("overview"),c()}),r.on("click","#manageaccess-share-add-more",function(){b("share"),E()}),r.on("click","#manageaccess-share-update",function(){p(y()),b("overview"),e("#manageaccess-share-update",r).prop("disabled",!0)}),r.on("change",'.oae-large-options-container input[type="radio"]',function(){e(".oae-large-options",r).removeClass("checked"),e(this).parents(".oae-large-options").addClass("checked")}),r.on("click",".oae-listitem-actions .close",d),r.on("change",".oae-listitem-actions select",v),r.on("click",".manageaccess-cancel",function(){b("overview")}),r.on("click","#manageaccess-overview-save",l)};N(),C()}});