define(["jquery","underscore","oae.core"],function(e,t,n){return function(r,i,s){var o=e("#"+r),u=!1,a=function(e,t){return e.image&&!t.image?-1:!e.image&&t.image?1:0},f=function(e,t){return e["oae:threadKey"].split("#").pop()<t["oae:threadKey"].split("#").pop()?1:-1},l=function(n){var r=[];return e.each(n,function(e,n){var i=t.findWhere(r,{published:n.published});if(!i){if(n.inReplyTo){var s=t.findWhere(r,{published:n.inReplyTo.published});s||r.push(n.inReplyTo)}r.push(n)}}),e.each(r,function(e,n){n["oae:level"]=0;if(n.inReplyTo){var i=t.findWhere(r,{published:n.inReplyTo.published});n["oae:level"]=i["oae:level"]+1}}),r},c=function(n,r){var i=!0;return e.each(n,function(e,n){var s=t.findWhere(r,{"oae:id":n["oae:id"]});s||(i=!1)}),i},h=function(t){return e.each(t.items,function(e,t){t.actor["oae:collection"]&&t.actor["oae:collection"].sort(a),t.object&&t.object["oae:collection"]&&t.object["oae:collection"].sort(a),t.target&&t.target["oae:collection"]&&t.target["oae:collection"].sort(a);if(t["oae:activityType"]==="content-comment"||t["oae:activityType"]==="discussion-message"){var n=t.object["oae:collection"];n||(n=[t.object]);var r=n.slice();n.sort(f),n=n.splice(0,2),n=l(n);var i=c(r,n);t.object["oae:collection"]=n,t.object.hasAllComments=i}}),{results:t.items}},p=function(){u&&u.kill();var t="/api/activity/"+s.principalId;u=e(".oae-list",o).infiniteScroll(t,{limit:10},"#activity-items-template",{postProcessor:h,emptyListProcessor:d})},d=function(){n.api.util.template().render(e("#activity-noresults-template",o),null,e(".oae-list",o))};p()}});