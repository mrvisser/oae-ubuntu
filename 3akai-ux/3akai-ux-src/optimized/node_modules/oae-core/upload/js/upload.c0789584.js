define(["jquery","oae.core","jquery.fileupload","jquery.iframe-transport","jquery.jeditable"],function(e,t){return function(n){var r=e("#"+n),i=[],s=0,o=t.api.config.getValue("oae-content","visibility","files"),u=!e.support.xhrFileUpload&&!e.support.xhrFormDataFileUpload,a=null,f=function(){o=t.api.config.getValue("oae-content","visibility","files"),e("#upload-permissions-container",r).html(""),i=[],s=0,e("form",r)[0].reset(),e(".modal-body > div",r).hide(),e(".modal-body > div:first-child",r).show(),e("#upload-modal > .modal-footer",r).show(),e("#upload-upload",r).hide(),e("#upload-upload",r).prop("disabled",!1),e("#upload-permissions",r).hide(),e("#upload-change-permissions",r).prop("disabled",!1),e(".progress",r).hide(),c(0),e("#upload-browse-button",r).removeClass("oae-focus")},l=function(t){e.each(t.files,function(e,t){var n=!1;u?t.name&&(n=!0):t.size>0&&t.name&&(n=!0,s+=t.size);if(n){var r={displayName:t.name,description:"",file:t,type:"file"};i.push(r)}})},c=function(t){e(".bar",r).css("width",t+"%")},h=function(t){t=e.trim(t);var n=this.revert,r=e(this).parents("li.oae-list-item");if(!t)return n;var s=e("#upload-selected-container li").index(r);return i[s].displayName=t,t},p=function(n){var s=t.api.util.template().render(e("#upload-notification-title-template",r),{context:a,errCount:n,files:i}),o=t.api.util.template().render(e("#upload-notification-body-template",r),{context:a,errCount:n,files:i});t.api.util.notification(s,o,n?"error":"success"),n||e("#upload-modal",r).modal("hide")},d=function(t){S(),e("#upload-input",r).fileupload("add",t.files),l(t.data),y()},v=function(){e("#upload-dropzone",r).show()},m=function(){e(".modal-body > div",r).hide(),e("#upload-modal > .modal-footer",r).hide(),e(".modal-body > div#upload-permissions-container",r).show(),e("#upload-upload",r).hide()},g=function(){e(".modal-body > div",r).hide(),e("#upload-modal > .modal-footer",r).show(),e(".modal-body > div#upload-overview-container",r).show(),e("#upload-permissions",r).show(),e("#upload-upload",r).show()},y=function(){t.api.util.template().render("#upload-selected-template",{files:i},e("#upload-selected-container",r)),w(),e("#upload-selected-container li:first-child",r).focus(),e("#upload-selected-container li .icon-spinner",r).hide(),e(".jeditable-field",r).editable(h,{onblur:"submit",select:!0}),e('[rel="tooltip"]',r).tooltip()},b=function(){e("#upload-modal").on("hidden",function(t){e(t.target).hasClass("modal")&&f()})},w=function(){var n=e("#upload-permissions-container",r);n.html("");var s=t.api.util.generateId();e(document).on("oae.setpermissions.changed."+s,function(n,s){o=s.visibility;var u=_.pluck(s.viewers,"id");u=_.without(u,t.data.me.id),a.addedToGroupContext=_.contains(u,a.id),e.each(i,function(e,t){t.viewers=u}),e("#upload-permissions-summary",r).html(s.summary),g()}),e(document).on("oae.setpermissions.cancel."+s,g),t.api.widget.insertWidget("setpermissions",s,n,!1,{count:i.length,type:"file",visibility:o})},E=function(){r.on("click",".upload-trash",function(t){var n=e(this).parents("li.oae-list-item"),o=e("#upload-selected-container li",r).index(n);s-=i[o].file.size,i.splice(o,1),n.remove(),i.length||(f(),S())})},S=function(){var t=!1,n=0,i=0,o={url:"/api/content/create",dropZone:e("#upload-dropzone",r),forceIframeTransport:u,replaceFileInput:!1,drop:function(e,t){l(t),g(),y()},add:function(){},change:function(e,t){l(t),g(),y()},progress:function(e,r){t||(t=r.total),t===r.total?n=r.loaded:(i+=t,t=r.total,n=r.loaded),c((i+n)/s*100)}};e("#upload-input",r).fileupload(o)},x=function(){e("#upload-upload",r).on("click",function(){var n=0,s=0;u||e(".progress",r).show(),e("#upload-upload",r).prop("disabled",!0),e(".upload-trash",r).prop("disabled",!0),e("#upload-change-permissions",r).prop("disabled",!0),e(".jeditable-field",r).editable("destroy"),e('[rel="tooltip"]',r).tooltip("destroy"),e("#upload-modal",r).modal("lock");var a=function(f){var l=i[f];if(l){var h=e(e("#upload-selected-container li",r)[f]),d=h.find(".icon-spinner"),v=h.find(".icon-ok"),m=h.find(".icon-warning-sign");h.focus(),d.show(),t.api.content.createFile(l.displayName,l.description,o,e("#upload-input",r),l.file,[],l.viewers,function(t,o){d.hide(),t?(m.show(),s++):(v.show(),l.profilePath=o.profilePath),n++,n!==i.length?a(n):(e(window).trigger("done.addcontent.oae"),e("#upload-modal",r).modal("unlock"),u||c(100),p(s))})}};a(0)})},T=function(){e(document).on("click",".oae-trigger-upload",function(){e("#upload-modal",r).modal({backdrop:"static"}),v(),S()}),e(document).on("oae.trigger.upload",function(t,n){e("#upload-modal",r).modal({backdrop:"static"}),g(),d(n)}),e("#upload-change-permissions",r).on("click",function(){m()}),e(document).on("oae.context.send.upload",function(e,t){a=t}),e(document).trigger("oae.context.get","upload")};b(),x(),T(),E()}});