define(["jquery","oae.core","jquery.jeditable"],function(e,t){return function(n){$rootel=e("#"+n);var r=new RegExp(/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i),i=t.api.config.getValue("oae-content","visibility","links"),s=[],o=null,u=function(){i=t.api.config.getValue("oae-content","visibility","links"),e("#createlink-permissions-container",$rootel).html(""),s=[],e(".modal-body > div",$rootel).hide(),e("#createlink-link-dump-container",$rootel).show(),e("#createlink-modal > .modal-footer",$rootel).show(),e("#createlink-next",$rootel).prop("disabled",!0),e("#createlink-next",$rootel).show(),e("#createlink-link-dump",$rootel).val(""),e("#createlink-create",$rootel).hide(),e("#createlink-create",$rootel).prop("disabled",!1),e("#createlink-change-permissions",$rootel).prop("disabled",!1)},a=function(e){return e.match(/https?:\/\/|s?ftp:\/\//)||(e="http://"+e),e&&r.test(e)?e:!1},f=function(){var t=e("#createlink-link-dump",$rootel).val().split("\n");t=_.unique(t);var n=[];return e.each(t,function(e,t){var r=a(t);r&&n.push(r)}),n},l=function(e){var t={link:e,displayName:e,description:"",type:"link"};s.push(t)},c=function(t){t=e.trim(t);var n=this.revert,r=e(this).parents("li.oae-list-item");if(!t)return n;var i=e("#createlink-selected-container li",$rootel).index(r);return s[i].displayName=t,t},h=function(n){var r=t.api.util.template().render(e("#createlink-notification-title-template",$rootel),{context:o,errCount:n,links:s}),i=t.api.util.template().render(e("#createlink-notification-body-template",$rootel),{context:o,errCount:n,links:s});t.api.util.notification(r,i,n?"error":"success"),n||e("#createlink-modal",$rootel).modal("hide")},p=function(){e(".modal-body > div:visible",$rootel).hide(),e("#createlink-modal > .modal-footer",$rootel).hide(),e(".modal-body > div#createlink-permissions-container",$rootel).show(),e("#createlink-create",$rootel).hide()},d=function(){e(".modal-body > div:visible",$rootel).hide(),e("#createlink-next",$rootel).hide(),e("#createlink-modal > .modal-footer",$rootel).show(),e(".modal-body > div#createlink-overview-container",$rootel).show(),e("#createlink-create",$rootel).show()},v=function(){t.api.util.template().render(e("#createlink-selected-template",$rootel),{links:s},e("#createlink-selected-container",$rootel)),y(),e("#createlink-selected-container li:first-child",$rootel).focus(),e("#createlink-selected-container li .icon-spinner",$rootel).hide(),e(".jeditable-field",$rootel).editable(c,{onblur:"submit",select:!0}),e('[rel="tooltip"]',$rootel).tooltip()},m=function(){e("#createlink-modal",$rootel).on("hidden",function(t){e(t.target).hasClass("modal")&&u()})},g=function(){$rootel.on("click",".createlink-trash",function(t){var n=e(this).parents("li.oae-list-item"),r=e("#createlink-selected-container li",$rootel).index(n);s.splice(r,1),n.remove(),s.length||u()})},y=function(){var n=e("#createlink-permissions-container",$rootel);n.html("");var r=t.api.util.generateId();e(document).on("oae.setpermissions.changed."+r,function(n,r){i=r.visibility;var u=_.pluck(r.viewers,"id");u=_.without(u,t.data.me.id),o.addedToGroupContext=_.contains(u,o.id),e.each(s,function(e,t){t.viewers=u}),e("#createlink-permissions-summary",$rootel).html(r.summary),d()}),e(document).on("oae.setpermissions.cancel."+r,d),t.api.widget.insertWidget("setpermissions",r,n,!1,{count:s.length,type:"link",visibility:i})},b=function(){e("#createlink-next",$rootel).on("click",function(){var t=f();e.each(t,function(e,t){l(t)}),s.length>0&&(d(),v())})},w=function(){e("#createlink-create",$rootel).on("click",function(){var n=0,r=0;e("#createlink-create",$rootel).prop("disabled",!0),e(".createlink-trash",$rootel).prop("disabled",!0),e("#createlink-change-permissions",$rootel).prop("disabled",!0),e(".jeditable-field",$rootel).editable("destroy"),e('[rel="tooltip"]',$rootel).tooltip("destroy");var o=function(u){var a=s[u];if(a){var f=e(e("#createlink-selected-container li",$rootel)[u]),l=f.find(".icon-spinner"),c=f.find(".icon-ok"),p=f.find(".icon-warning-sign");f.focus(),l.show(),t.api.content.createLink(a.displayName,a.description,i,a.link,[],a.viewers,function(t,i){l.hide(),t?(p.show(),r++):(c.show(),a.profilePath=i.profilePath),n++,n!==s.length?o(n):(e(window).trigger("done.addcontent.oae"),h(r))})}};o(0)})},E=function(){e("#createlink-link-dump",$rootel).on("keyup paste",function(t){setTimeout(function(){var t=f();t.length?e("#createlink-next",$rootel).prop("disabled",!1):e("#createlink-next",$rootel).prop("disabled",!0)},1)})},S=function(){e(document).on("click",".oae-trigger-createlink",function(){e("#createlink-modal",$rootel).modal({backdrop:"static"}),e("#createlink-modal",$rootel).on("shown",function(){e("#createlink-link-dump",$rootel).focus()})}),e("#createlink-change-permissions",$rootel).on("click",p),e(document).on("oae.context.send.createlink",function(e,t){o=t}),e(document).trigger("oae.context.get","createlink")};m(),b(),g(),E(),S(),w()}});