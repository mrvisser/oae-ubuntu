require(["jquery","sakai/sakai.api.core"],function(e,t){sakai_global.relatedcontent=function(n,r){var i="#relatedcontent",s=i+"_container",o=i+"_default_template",u=".relatedcontent_content",a="#relatedcontent_footer",f="#relatedcontent_show_more",l={},c=0,h=5,p=function(n){n.sakai=t;if(n.hasOwnProperty("relatedContent")&&n.relatedContent.hasOwnProperty("results")){for(var r in n.relatedContent.results)n.relatedContent.results.hasOwnProperty(r)&&(n.relatedContent.results[r]["sakai:pooled-content-file-name-dotted"]=t.api.Util.applyThreeDots(n.relatedContent.results[r]["sakai:pooled-content-file-name"],e(".relatedcontent").width()-30,{max_rows:1,whole_word:!1},"oae-bold"));t.api.Util.TemplateRenderer(o,n,e(s)),e(s).show()}},d=function(){var n="",r="",i=function(n){var r=n.items*(c+1),i=r<n.total;e.each(n.results,function(e,r){n.results[e].commentcount=t.api.Content.getCommentCount(r);var i=t.api.Content.getMimeType(n.results[e]),s=t.api.i18n.getValueForKey(t.config.MimeTypes.other.description);t.config.MimeTypes[i]&&(s=t.api.i18n.getValueForKey(t.config.MimeTypes[i].description)),n.results[e].mimeTypeDescription=s});var s={content:l,relatedContent:n};p(s),i?(e(f).show(),e("#relatedcontent_footer").removeClass("relatedcontent_footer_norelated")):(e(f).hide(),e("#relatedcontent_footer").addClass("relatedcontent_footer_norelated"))},s=function(){p({})};for(var o=0;o<l.members.managers.length;o++)l.members.managers[o]&&(n+=" "+(l.members.managers[o]["rep:userId"]||l.members.managers[o]["sakai:group-id"]));for(var u=0;u<l.members.viewers.length;u++)l.members.viewers[u]&&(r+=" "+(l.members.viewers[u]["rep:userId"]||l.members.viewers[u]["sakai:group-id"]));var a=l.data["sakai:pooled-content-file-name"].substring(0,400)+" "+n+" "+r;l.data["sakai:tags"]&&l.data["sakai:tags"].length&&(a=a+" "+l.data["sakai:tags"].join(" "));var d=t.api.Server.createSearchString(a,!1,"OR"),v={items:h,page:c},m=t.config.URL.SEARCH_ALL_FILES.replace(".json",".0.json");d==="*"||d==="**"?m=t.config.URL.SEARCH_ALL_FILES_ALL:v.q=d,e.ajax({url:m,data:v,success:i,error:s})},v=function(){e(f).prop("disabled",!0),c++,d()},m=function(){e(f).off("click",v),e(f).on("click",v)};e(window).on("render.relatedcontent.sakai",function(e,t){c=0,m(),l=t,d()}),e(u).on("click",function(){e.bbq.pushState(e(this).attr("data-href"))}),e(window).trigger("ready.relatedcontent.sakai",{}),sakai_global.relatedcontent.isReady=!0},t.api.Widgets.widgetLoader.informOnLoad("relatedcontent")});