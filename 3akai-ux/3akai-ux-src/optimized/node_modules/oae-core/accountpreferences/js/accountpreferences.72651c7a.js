define(["jquery","oae.core"],function(e,t){return function(n,r){$rootel=e("#"+n);var i=function(){e("form",$rootel).each(function(n,r){e(r)[0].reset(),t.api.util.validation().clear(r)}),e("#accountpreferences-tab-container ul li:first-child a").click()},s=function(){var n=e("#accountpreferences-current-password",$rootel).val(),r=e("#accountpreferences-new-password",$rootel).val();return t.api.authentication.changePassword(n,r,function(n){n?n.code===400?t.api.util.notification(t.api.i18n.translate("__MSG__PASSWORD_NOT_UPDATED__","accountpreferences"),t.api.i18n.translate("__MSG__YOUR_PASSWORD_CANNOT_BE_CHANGED_HERE__","accountpreferences"),"error"):n.code===401?t.api.util.notification(t.api.i18n.translate("__MSG__PASSWORD_NOT_UPDATED__","accountpreferences"),t.api.i18n.translate("__MSG__THE_PROVIDED_PASSWORD_IS_INCORRECT__","accountpreferences"),"error"):t.api.util.notification(t.api.i18n.translate("__MSG__PASSWORD_NOT_UPDATED__","accountpreferences"),t.api.i18n.translate("__MSG__PASSWORD_UPDATE_FAILED__","accountpreferences"),"error"):(e("#accountpreferences-modal",$rootel).modal("hide"),t.api.util.notification(t.api.i18n.translate("__MSG__PASSWORD_UPDATED__","accountpreferences"),t.api.i18n.translate("__MSG__PASSWORD_SUCCESSFULLY_UPDATED__","accountpreferences")))}),!1},o=function(){var n={locale:e("#accountpreferences-language",$rootel).val(),timezone:e("#accountpreferences-timezone",$rootel).val()};return t.api.user.updateUser(n,function(n){n?t.api.util.notification(t.api.i18n.translate("__MSG__PREFERENCES_NOT_UPDATED__","accountpreferences"),t.api.i18n.translate("__MSG__PREFERENCES_UPDATE_FAILED__","accountpreferences"),"error"):(e("#accountpreferences-modal",$rootel).modal("hide"),t.api.util.notification(t.api.i18n.translate("__MSG__PREFERENCES_UPDATED__","accountpreferences"),t.api.i18n.translate("__MSG__PREFERENCES_SUCCESSFULLY_UPDATED__","accountpreferences")),setTimeout(function(){document.location.reload()},2e3))}),!1};setUpValidation=function(){t.api.util.validation().validate(e("#accountpreferences-password",$rootel),{rules:{"accountpreferences-new-password":{minlength:6},"accountpreferences-retype-password":{equalTo:"#accountpreferences-new-password"}},messages:{"accountpreferences-new-password":{required:t.api.i18n.translate("__MSG__PLEASE_ENTER_YOUR_PASSWORD__"),minlength:t.api.i18n.translate("__MSG__YOUR_PASSWORD_SHOULD_BE_AT_LEAST_SIX_CHARACTERS_LONG__")},"accountpreferences-retype-password":{required:t.api.i18n.translate("__MSG__PLEASE_REPEAT_YOUR_PASSWORD__"),passwordmatch:t.api.i18n.translate("__MSG__THIS_PASSWORD_DOES_NOT_MATCH_THE_FIRST_ONE__")}},submitHandler:s}),t.api.util.validation().validate(e("#accountpreferences-preferences",$rootel),{submitHandler:o})};var u=function(e,t){return e.offset===t.offset?e.displayName>t.displayName?1:-1:e.offset-t.offset},a=function(t){var n=[];return e.each(t,function(e,t){t.id=e,t.offset=-1*t.offset;var r=Math.abs(t.offset),i=Math.floor(r),s=r%1*60,o=Globalize.format(new Date(0,0,0,i,s),"HH:mm");t.offset>=0?t.offsetString="GMT+"+o:t.offsetString="GMT-"+o,n.push(t)}),n.sort(u),n},f=function(){t.api.util.template().render(e("#accountpreferences-language-template",$rootel),null,e("#accountpreferences-language",$rootel)),e.ajax({url:"/api/timezones",success:function(n){n=a(n),t.api.util.template().render(e("#accountpreferences-timezone-template",$rootel),{timezones:n},e("#accountpreferences-timezone",$rootel)),e("#accountpreferences-language",$rootel).val(t.data.me.locale.locale),e("#accountpreferences-timezone",$rootel).val(t.data.me.timezone)}})},l=function(){e(document).on("click",".oae-trigger-accountpreferences",function(){e("#accountpreferences-modal",$rootel).modal({backdrop:"static"}),f(),setUpValidation()}),e("#accountpreferences-modal",$rootel).on("hidden",i)};l()}});